<!DOCTYPE html>
<html>
    <head>
        <title>i2v Test</title>
        <!-- data-main attribute tells require.js to load
             scripts/main.js after require.js loads. -->

    </head>
    <body>
        <h1>i2v Test</h1>
        <div id="i2vCanvas">

        </div>

        <script src="npm/requirejs/require.js"></script>
        <script>
        require([
            "p4/io/ajax",
            "p4/io/parser",
            "p4/cquery/ctypes",
            "p4/cquery/cstore",
            "p4/core/datastruct",
            "p4/core/pipeline",
            "p4/core/arrays",
            "glCompute",
        ],
        function(
            ajax,
            parser,
            ctypes,
            CStore,
            dataStruct,
            pipeline,
            arrays,
            glCompute
        ){
            ajax.getAll([
                //  {url: "randomData.csv", dataType: "text"},
                 {url: "/metadata", dataType: "json"},
                 {url: "/data", dataType: "arraybuffer"}
            ]).then(function(response){
                // var text = response[0],
                    metadata = response[0],
                    binaryData = response[1];
                console.log(metadata);
                // console.log(binaryData);
                var types = metadata.types,
                    size = metadata.size,
                    offset = 0;
                // var csv = parser(text, ',');
                var db = CStore({
                    size: size,
                    struct: [
                        {name: "rank", type: "int"},
                        {name: "timestamp", type: "float"},
                        {name: "numeric1", type: "int"},
                        {name: "numeric2", type: "int"},
                        {name: "categorical1", type: "string"},
                        {name: "numeric3", type: "int"}
                    ],
                });

                metadata.keys.forEach(function(k, i){
                    var data = new ctypes[types[i]](binaryData.slice(offset, offset+size*ctypes[types[i]].BYTES_PER_ELEMENT));
                    offset += size * ctypes[types[i]].BYTES_PER_ELEMENT;
                    db.addColumns(data, k);
                });
                //

                var test = glCompute(db);
                var start = new Date();
                // test.group();
                test.filter();
                test.group();
                // console.log(new Date() - start);

            });
        });
        </script>
    </body>
</html>
