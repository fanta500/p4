<!DOCTYPE html>
<html>
    <head>
        <title>i2v Test</title>
        <!-- data-main attribute tells require.js to load
             scripts/main.js after require.js loads. -->
        <style>
        .i2v-viz {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome and Opera */
        }
        </style>
    </head>
    <body>
        <h1>i2v Test</h1>
        <div id="i2vCanvas">

        </div>

        <script src="/npm/requirejs/require.js"></script>
        <script>
        require([
            "p4/io/ajax",
            "p4/io/parser",
            "p4/cquery/ctypes",
            "p4/cquery/cstore",
            "p4/core/datastruct",
            "p4/core/pipeline",
            "p4/core/arrays",
            "../src/adav",
            // "glCompute",
        ],
        function(
            ajax,
            parser,
            ctypes,
            CStore,
            dataStruct,
            pipeline,
            arrays,
            adav
            // glCompute
        ){
            ajax.getAll([
                 {url: "../randomData.csv", dataType: "text"},
                //  {url: "../Nat200k.csv", dataType: "text"},
                //  {url: "/metadata", dataType: "json"},
                //  {url: "/data", dataType: "arraybuffer"}
            ]).then(function(response){
                // var text = response[0],
                //     metadata = response[1],
                //     binaryData = response[2];
                // // console.log(metadata);
                // // console.log(binaryData);
                // var types = metadata.types,
                //     size = metadata.size,
                //     offset = 0;

                var csv = parser(response[0], ',');

                var db = CStore({
                    size: csv.length,
                    struct: [
                        {name: "rank", type: "int"},
                        {name: "timestamp", type: "time"},
                        {name: "numeric1", type: "int"},
                        {name: "numeric2", type: "int"},
                        {name: "categorical1", type: "string"},
                        {name: "numeric3", type: "int"}
                    ],
                });
                // var db = CStore({
                //     size: csv.length,
                //     struct: {
                //         Month: "int",
                //         Time: "int",
                //         DayOfWeek: "int",
                //         MotherAge: "int",
                //         MotherRace: "string",
                //         MotherMartialStatus: "string",
                //         MotherEducation: "string",
                //         FatherAge: "int",
                //         FatherRace: "string",
                //         FatherEducation: "string",
                //         MotherHeight: "float",
                //         MotherWeight: "float",
                //         MotherWeightGain: "int",
                //         BabyGender: "string",
                //         BabyWeight: "float"
                //     },
                // });

                // metadata.keys.forEach(function(k, i){
                //     var data = new ctypes[types[i]](binaryData.slice(offset, offset+size*ctypes[types[i]].BYTES_PER_ELEMENT));
                //     offset += size * ctypes[types[i]].BYTES_PER_ELEMENT;
                //     db.addColumns(data, k);
                // });

                db.addRows(csv);

                var data = db.data();
                data.stats = db.stats();
                console.log(data);
                // var glc = glCompute(db);
                // glc.group();
                var start = new Date();

                var test = adav({
                    config: {padding: {left: 70, right: 10, top:10, bottom: 20}},
                    width: 600,
                    height: 600,
                    data: data,
                    // indexes: ["timestamp" , "rank"]
                    // indexes: ["rank", "timestamp"]
                });
                // var test = glCompute(db);

                console.log("setup time", new Date() - start);
                var start = new Date();

                var result = test
                .register('test')
                // .filter({
                //     // group_id: [0, 5],
                //     rank: [2, 400],
                //     // numeric1: [30, 31]
                //     // timestamp: [1000, 32000]
                // })
                .filter({
                    rank: {$in:[2,4,6,8,10,12,14,18,20,30,40,50,60,70,80,100,150,200,250,300]},
                    //  rank: [2, 300]
                })
                .derive({
                    group_id : "floor(rank/16.0)",
                    // ts: "floor(@timestamp/1000.0)",
                })
                .aggregate({
                    $by: ['group_id'],
                    n1 : {$max: "numeric1"},
                    n2 : {$avg: "numeric2"},
                    n3 : {$sum: "numeric3"},
                })
                // .aggregate({
                //     $by: ['group_id'],
                //     n1 : {$sum: "n1"},
                //     n2 : {$sum: "n2"},
                //     n3 : {$sum: "n3"},
                // })
                // .visualize({
                //     mark: 'point',
                //     x: 'timestamp',
                //     y: 'numeric3',
                //     // size: 'numeric3'
                // })
                //
                // .visualize({
                //     mark: 'point',
                //     x: 'n1',
                //     y: 'n2',
                //     // size: 'numeric3'
                // })
                // .resume('test')
                // .aggregate({
                //     $by: "categorical1",
                //     n1 : {$sum: "numeric1"},
                //     n2 : {$sum: "numeric2"},
                //     n3 : {$sum: "numeric3"},
                // })
                .result();

                console.log(result);
                // .visualize({
                //     mark: 'bar',
                //     x: 'categorical1',
                //     y: 'n1',
                //     // size: 'numeric3'
                // })

                // .resume('test')
                // .group({
                //     $by: "group_id",
                //     numeric1: "$sum",
                //     // numeric2: "$sum",
                //     // numeric3: "$sum",
                // })
                // .cache('testResults')
                // .visualize({
                //     mark: 'point',
                //     x: 'numeric2',
                //     y: 'numeric1',
                //     // size: 'numeric3'
                // });

                // var res2 = adav({
                //     data: data,
                // })
                // .group({
                //     $by: "rank",
                //     // $by: "rank",
                //     numeric1: "$sum",
                //     numeric2: "$sum",
                //     numeric3: "$sum",
                // })
                // .result();

                // console.log(result);
                // console.log(new Date() - start);
                // //
                // var objectArray = dataStruct({
                //     array: csv,
                //     types: ['int', 'float', "int", "int", "string", "int"],
                //     header: ["rank", "timestamp", 'numeric1', "numeric2", "categorical1", "numeric3"],
                // }).objectArray();
                // //
                // start = new Date();
                //
                // var checkResult = pipeline()
                // .derive({
                //     group_id : "Math.floor(@rank/16.0)",
                //     // ts: "floor(@timestamp/1000.0)",
                // })
                // // .match({
                // //     // group_id: {$inRange: [0, 8]},
                // //     rank: {$inRange: [2, 100]},
                // //     // timestamp: {$inRange: [512000, 1024000]}
                // //     // numeric1: {$inRange: [0, 20]}
                // // })
                // .group({
                //     $by: ['timestamp', 'group_id'],
                //     // $by: "group_id",
                //     // rank: "$sum",
                //     numeric1: "$sum",
                //     numeric2: "$sum",
                //     numeric3: "$sum",
                // })
                // // .group({
                // //     $by: ['timestamp', 'group_id'],
                // //     // rank: "$sum",
                // //     // rank: "$sum",d
                // //     numeric1: "$sum",
                // //     // numeric2: "$sum",
                // //     // numeric3: "$sum",
                // // })
                // (objectArray);
                //
                // console.log(new Date() - start);
                // console.log(checkResult);
                // // console.log(checkResult.map(function(d){return d.rank}));
                // console.log(arrays.min(checkResult.map(function(d){return d.numeric1})));
                // console.log(arrays.min(checkResult.map(function(d){return d.numeric2})));
                // console.log(arrays.min(checkResult.map(function(d){return d.numeric3})));

            });
        });
        </script>
    </body>
</html>
