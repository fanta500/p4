<!DOCTYPE html>
<html>
<head>
  <!-- Import Vega 3 & Vega-Lite 2 js (does not have to be from cdn) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vega/3.0.0-beta.25/vega.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vega-lite/2.0.0-alpha.7/vega-lite.js"></script>
  <!-- Import evga-embed -->
  <script src="https://vega.github.io/vega-embed/vega-embed.min.js"></script>
</head>
<body>

<div id="benchmark"></div>
<div id="vis"></div>

<script src="/npm/requirejs/require.js"></script>
<script type="text/javascript">
require([
    "p4/io/ajax",
    "p4/io/parser",
    "p4/cquery/ctypes",
    "p4/cquery/cstore",
    "p4/core/datastruct",
    "p4/core/pipeline",
    "p4/core/arrays",
    "p4/dataopt/stats",
    "../src/adav",
    "./test-vega",

],
function(
    ajax,
    parser,
    ctypes,
    CStore,
    dataStruct,
    pipeline,
    arrays,
    stats,
    adav,
    testVega
){
    // var dataDownloadEnd,
    //     dataDownloadStart= performance.now();
    // ajax.getAll([
    //      {url: "../Nat2015usa.csv", dataType: "text"},
    //     //  {url: "/metadata", dataType: "json"},
    //     //  {url: "/data", dataType: "arraybuffer"}
    // ]).then(function(response){
    //     dataDownloadEnd = performance.now();
    //
    //     var attributes = {
    //         Month: "int",//0
    //         Time: "int",//1
    //         DayOfWeek: "int",//2
    //         MotherAge: "int", //3
    //         MotherRace: "string", //4
    //         MotherMartialStatus: "string", //5
    //         MotherEducation: "string", //6
    //         FatherAge: "int", //7
    //         FatherRace: "string", //8
    //         FatherEducation: "string", //9
    //         MotherHeight: "int", //10
    //         MotherWeight: "int", //11
    //         MotherWeightGain: "int", //12
    //         Gender: "string",//13
    //         Weight: "int" //14
    //     }
    //
    //     var csv = parser(response[0], ',');
    //
    //     var objectArray = dataStruct({
    //         array: csv,
    //         types: Object.keys(attributes).map(function(k){return attributes[k];}),
    //         header: Object.keys(attributes),
    //     }).objectArray();

        var benchmark = {
            adav: [],
            vega: []
        };

        function benchmarkVega(dataSize) {
            var data;

            data = new Array(dataSize);
            for(var i = 0; i < dataSize; i++) {
                var obj = {};
                obj.Weight = Math.random() * 6000;
                obj.MotherWeight = Math.random() *  400;
                obj.MotherAge =13 + Math.floor(Math.random() *  50);
                obj.FatherAge =16 + Math.floor(Math.random() *  75);
                data[i] = obj;
            }

            var domains = {
                Weight: [0, 6000],
                MotherWeight: [0, 800]
            };

            domains.Weight[1] = Math.random() * 6000;
            domains.MotherWeight[1] =  Math.random() * 400;
            return testVega(data, domains);
        }

        function testCPU(data, domains) {
            var cpu = pipeline()
            // .derive({
            //     ratio: "@Weight/@MotherWeight",
            // })
            // .match({
            //     MotherWeight: {$inRange: domains.MotherWeight},
            //     Weight: {$inRange: domains.Weight},
            // })
            .group({
                $by: "MotherAge",
                Weight: "$count",
                MotherWeight: "$avg"
            });

            var p = performance.now();
            var r = cpu(data);

            return performance.now() - p;
        }

        function benchmarkCPU(dataSize) {
            var data;

            data = new Array(dataSize);
            for(var i = 0; i < dataSize; i++) {
                var obj = {};
                obj.Weight = Math.random() * 6000;
                obj.MotherWeight = Math.random() *  400;
                obj.MotherAge =15 + Math.floor(Math.random() *  50);
                data[i] = obj;
            }

            var domains = {
                Weight: [0, 6000],
                MotherWeight: [0, 800]
            };

            domains.Weight[1] = Math.random() * 6000;
            domains.MotherWeight[1] =  Math.random() * 400;
            return testCPU(data, domains);
        }





        function benchmarkAdav(dataSize) {
            var data;

            var db = CStore({
                size: dataSize,
                struct: {
                    Weight: 'float',
                    MotherWeight: 'float',
                    MotherAge: "int",
                    FatherAge: "int",
                }
            });


            for(var i = 0; i < dataSize; i++) {
                var row = [];
                row[0] =  Math.random() * 6000;;
                row[1] = Math.random() *  400;
                row[2] = 15 + Math.floor(Math.random() *  50);
                db.addRows([row]);
            }

            var data = db.data();
            data.stats = db.stats();

            var domains = {
                Weight: [0, 6000],
                MotherWeight: [0, 800]
            };

            domains.Weight[1] = Math.random() * 6000;
            domains.MotherWeight[1] =  Math.random() * 400;
            return testAdav(data, domains);
        }


        var baseCase = 1000000;
        var testSizes = [500000, baseCase, baseCase*2, baseCase*4];


        // var results = [];
        // var ins = [];
        // var renders = [];
        // testSizes.forEach(function(t, i){
        //     // console.log('Benchmarking Vega ', testSizes[i]);
        //     var r, p = 0, itt = 0, ren = 0;
        //     for(var j = 0; j<4; j++) {
        //
        //         r = benchmarkVega(testSizes[i]);
        //         p += r.transform;
        //         itt += r.init;
        //         ren += r.render;
        //
        //     }
        //     results.push(p/4)
        //     ins.push(itt/4);
        //     renders.push(ren/4)
        //     console.log(testSizes[i]/1000+"K", p/4, itt/4, ren/4);
        // })
        // console.log('Benchmarking Vega Complete');
        // console.log(renders);
        //
        var results = [];
        var ins = [];
        var renders = [];
        testSizes.forEach(function(t, i){
            var r, p = 0, itt = 0, ren = 0;
            for(var j = 0; j<4; j++) {
                r = benchmarkAdav(testSizes[i])
                p += r.transform;
                itt += r.init;
                ren += r.render;
            }
            results.push(p/4)
            ins.push(itt/4)
            renders.push(ren/4)
            console.log(testSizes[i]/1000+"K", p/4, ren/4);
        })
        console.log(results, renders);

        // var results = [];
        // var ins = [];
        // testSizes.forEach(function(t, i){
        //     var p = 0;
        //     for(var j = 0; j<4; j++) {
        //         p += benchmarkCPU(testSizes[i]);
        //
        //     }
        //     results.push(p/4)
        //
        //     console.log(testSizes[i]/1000+"K", p/4);
        // })
        //
        //
        // console.log('Benchmarking CPU Complete');
        // console.log(results);
        // console.log(ins);


        function testAdav(data, domains) {
            var timestamp = performance.now();
            var profile = {
               init: timestamp,
               transform: null,
               render: null,
               total: timestamp
            };


            var test = adav({
                config: {padding: {left: 70, right: 10, top:10, bottom: 20}},
                width: 800,
                height: 800,
                data: data,
                // indexes: ["timestamp" , "rank"]
                // indexes: ["rank", "timestamp"]
            });


            test.ctx.finish();
            timestamp = performance.now();
            profile.init = timestamp - profile.init;
            profile.transform = timestamp;

            test
            // .derive({
            //     AgeDiff: "abs( FatherAge - MotherAge )"
            // })
            .filter({
                Weight: domains.Weight,
                MotherWeight: domains.MotherWeight
            })
            // .aggregate({
            //     $by: "AgeDiff",
            //     avgMomWeight: {$sum: "MotherWeight"},
            //     BabyCount: {$count: "*"}
            // })
            test.ctx.finish();
            timestamp = performance.now();
            profile.transform = timestamp - profile.transform;
            profile.render = timestamp;
            test.visualize({
                mark: "line",
                // perceptual: true,
                x: "Weight",
                y: "MontherAge"
            });
            test.ctx.finish();
            timestamp = performance.now();
            profile.render = timestamp - profile.render;


            profile.total = timestamp - profile.total;
            profile.exec = profile.total - profile.init;
            console.log(profile);
            return profile;
        }
        // console.log(profile);

});
</script>
</body>
</html>
